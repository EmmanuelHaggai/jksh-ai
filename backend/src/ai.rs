use crate::{
    error::{AppError, Result},
    models::*,
    financial::FinancialService,
    cache::Cache,
};
use std::sync::Arc;
use std::collections::HashMap;
use serde_json::json;
use chrono::Utc;

pub struct AIService {
    financial_service: Arc<FinancialService>,
    cache: Arc<Cache>,
    knowledge_base: FinancialKnowledgeBase,
}

impl AIService {
    pub fn new(financial_service: Arc<FinancialService>, cache: Arc<Cache>) -> Self {
        Self {
            financial_service,
            cache,
            knowledge_base: FinancialKnowledgeBase::new(),
        }
    }

    pub async fn process_query(&self, request: AIRecommendationRequest) -> Result<AIRecommendationResponse> {
        let cache_key = format!("ai_query_{}", sha256::digest(&request.query));
        
        // Try cache first for frequently asked questions
        if let Ok(Some(cached)) = self.cache.get::<AIRecommendationResponse>(&cache_key).await {
            return Ok(cached);
        }

        // Analyze the query intent
        let intent = self.analyze_query_intent(&request.query);
        
        // Generate response based on intent
        let response = match intent.intent_type.as_str() {
            "stock_analysis" => self.handle_stock_analysis_query(&request, &intent).await?,
            "portfolio_advice" => self.handle_portfolio_advice_query(&request, &intent).await?,
            "market_prediction" => self.handle_market_prediction_query(&request, &intent).await?,
            "investment_advice" => self.handle_investment_advice_query(&request, &intent).await?,
            "risk_assessment" => self.handle_risk_assessment_query(&request, &intent).await?,
            "market_news" => self.handle_market_news_query(&request, &intent).await?,
            "educational" => self.handle_educational_query(&request, &intent).await?,
            _ => self.handle_general_query(&request, &intent).await?,
        };

        // Cache for frequently asked questions
        if intent.confidence > 0.8 {
            let cache_duration = match intent.intent_type.as_str() {
                "educational" => std::time::Duration::from_secs(3600), // 1 hour
                "market_news" => std::time::Duration::from_secs(300),  // 5 minutes
                _ => std::time::Duration::from_secs(900), // 15 minutes
            };
            let _ = self.cache.set(&cache_key, &response, Some(cache_duration)).await;
        }

        Ok(response)
    }

    fn analyze_query_intent(&self, query: &str) -> QueryIntent {
        let query_lower = query.to_lowercase();
        let words: Vec<&str> = query_lower.split_whitespace().collect();

        // Define intent patterns
        let intent_patterns = [
            ("stock_analysis", vec!["analyze", "analysis", "performance", "how is", "stock", "company"]),
            ("portfolio_advice", vec!["portfolio", "holdings", "diversify", "rebalance", "allocation"]),
            ("market_prediction", vec!["predict", "forecast", "future", "will go", "price target", "outlook"]),
            ("investment_advice", vec!["should i buy", "should i sell", "invest", "recommendation", "advice"]),
            ("risk_assessment", vec!["risk", "risky", "safe", "volatile", "conservative", "aggressive"]),
            ("market_news", vec!["news", "happening", "events", "latest", "updates", "market"]),
            ("educational", vec!["what is", "how does", "explain", "definition", "meaning", "learn"]),
        ];

        let mut best_match = ("general", 0);
        
        for (intent, keywords) in &intent_patterns {
            let matches = keywords.iter()
                .filter(|&&keyword| {
                    words.iter().any(|&word| word.contains(keyword)) ||
                    query_lower.contains(keyword)
                })
                .count();
            
            if matches > best_match.1 {
                best_match = (intent, matches);
            }
        }

        // Extract entities (stock symbols, numbers, etc.)
        let entities = self.extract_entities(&query);

        QueryIntent {
            intent_type: best_match.0.to_string(),
            confidence: (best_match.1 as f64 / 3.0).min(1.0).max(0.3),
            entities,
            raw_query: query.to_string(),
        }
    }

    fn extract_entities(&self, query: &str) -> HashMap<String, String> {
        let mut entities = HashMap::new();
        let words: Vec<&str> = query.split_whitespace().collect();

        // Extract stock symbols (2-5 uppercase letters)
        for word in &words {
            let clean_word = word.trim_matches(|c: char| !c.is_alphabetic()).to_uppercase();
            if clean_word.len() >= 2 && clean_word.len() <= 5 && clean_word.chars().all(|c| c.is_alphabetic()) {
                // Check if it's a known stock symbol
                if self.is_likely_stock_symbol(&clean_word) {
                    entities.insert("symbol".to_string(), clean_word);
                    break;
                }
            }
        }

        // Extract numbers (for amounts, percentages, timeframes)
        for word in &words {
            if let Ok(number) = word.trim_matches(|c: char| !c.is_numeric() && c != '.').parse::<f64>() {
                if word.contains('%') {
                    entities.insert("percentage".to_string(), number.to_string());
                } else if number > 1000.0 {
                    entities.insert("amount".to_string(), number.to_string());
                } else if number <= 365.0 && (query.contains("day") || query.contains("month")) {
                    entities.insert("timeframe".to_string(), number.to_string());
                }
            }
        }

        // Extract timeframe keywords
        if query.contains("today") || query.contains("1 day") {
            entities.insert("timeframe".to_string(), "1d".to_string());
        } else if query.contains("week") {
            entities.insert("timeframe".to_string(), "1w".to_string());
        } else if query.contains("month") {
            entities.insert("timeframe".to_string(), "1mo".to_string());
        } else if query.contains("year") {
            entities.insert("timeframe".to_string(), "1y".to_string());
        }

        entities
    }

    fn is_likely_stock_symbol(&self, symbol: &str) -> bool {
        // Common stock symbols
        let common_symbols = [
            "AAPL", "GOOGL", "MSFT", "AMZN", "TSLA", "NVDA", "META", "NFLX",
            "SPY", "QQQ", "IWM", "VOO", "VTI", "BRK", "JPM", "JNJ", "WMT",
            "PG", "UNH", "HD", "MA", "PYPL", "DIS", "ADBE", "CRM", "INTC",
            "AMD", "BABA", "NKE", "KO", "PFE", "MRK", "ABT", "TMO", "COST"
        ];
        
        common_symbols.contains(&symbol)
    }

    async fn handle_stock_analysis_query(&self, request: &AIRecommendationRequest, intent: &QueryIntent) -> Result<AIRecommendationResponse> {
        let symbol = intent.entities.get("symbol")
            .cloned()
            .unwrap_or_else(|| "SPY".to_string()); // Default to S&P 500

        // Get comprehensive analysis
        let technical_analysis = self.financial_service.analyze_stock(StockAnalysisRequest {
            symbol: symbol.clone(),
            analysis_type: "technical".to_string(),
            timeframe: intent.entities.get("timeframe"),
        }).await?;

        let fundamental_analysis = self.financial_service.analyze_stock(StockAnalysisRequest {
            symbol: symbol.clone(),
            analysis_type: "fundamental".to_string(),
            timeframe: None,
        }).await?;

        let market_data = self.financial_service.get_market_data(MarketDataRequest {
            symbols: vec![symbol.clone()],
            timeframe: Some("1d".to_string()),
        }).await?;

        let current_data = market_data.data.first().unwrap();

        let response_text = format!(
            "Here's a comprehensive analysis of {}:\n\n\
            üìä Current Price: ${:.2} ({:+.2}%)\n\
            Volume: {:,}\n\n\
            üîç Technical Analysis:\n\
            ‚Ä¢ Recommendation: {} (Confidence: {:.0}%)\n\
            ‚Ä¢ {}\n\n\
            üìà Fundamental Analysis:\n\
            ‚Ä¢ Recommendation: {} (Confidence: {:.0}%)\n\
            ‚Ä¢ {}\n\n\
            üí° Overall Assessment:\n\
            Based on both technical and fundamental factors, {} appears to be {}. \
            The technical indicators suggest {} momentum, while fundamentals show {} value.",
            symbol,
            current_data.price.to_f64().unwrap_or(0.0),
            current_data.change_percent.to_f64().unwrap_or(0.0),
            current_data.volume,
            technical_analysis.recommendation,
            technical_analysis.confidence * 100.0,
            technical_analysis.analysis_summary,
            fundamental_analysis.recommendation,
            fundamental_analysis.confidence * 100.0,
            fundamental_analysis.analysis_summary,
            symbol,
            self.determine_overall_sentiment(&technical_analysis, &fundamental_analysis),
            self.describe_momentum(&technical_analysis),
            self.describe_value(&fundamental_analysis)
        );

        let recommendations = vec![
            format!("Monitor {} closely for the next few trading sessions", symbol),
            "Consider your risk tolerance and investment horizon".to_string(),
            "Diversification is key - don't put all eggs in one basket".to_string(),
        ];

        let follow_up_questions = vec![
            format!("What's the price prediction for {} in 30 days?", symbol),
            format!("How does {} compare to its competitors?", symbol),
            "Should I add this to my portfolio?".to_string(),
            "What are the main risks with this investment?".to_string(),
        ];

        Ok(AIRecommendationResponse {
            response: response_text,
            recommendations,
            relevant_stocks: vec![symbol.clone()],
            confidence: (technical_analysis.confidence + fundamental_analysis.confidence) / 2.0,
            response_type: "analysis".to_string(),
            follow_up_questions,
        })
    }

    async fn handle_portfolio_advice_query(&self, _request: &AIRecommendationRequest, intent: &QueryIntent) -> Result<AIRecommendationResponse> {
        let advice_type = if intent.raw_query.contains("diversify") {
            "diversification"
        } else if intent.raw_query.contains("rebalance") {
            "rebalancing"
        } else if intent.raw_query.contains("allocation") {
            "allocation"
        } else {
            "general"
        };

        let response_text = match advice_type {
            "diversification" => {
                "üéØ Portfolio Diversification Strategy:\n\n\
                Diversification is crucial for risk management. Here's how to diversify effectively:\n\n\
                üåç Geographic Diversification:\n\
                ‚Ä¢ 60-70% US stocks\n\
                ‚Ä¢ 20-30% International developed markets\n\
                ‚Ä¢ 10-15% Emerging markets\n\n\
                üè≠ Sector Diversification:\n\
                ‚Ä¢ Technology: 15-20%\n\
                ‚Ä¢ Healthcare: 10-15%\n\
                ‚Ä¢ Financial Services: 10-15%\n\
                ‚Ä¢ Consumer Goods: 10-15%\n\
                ‚Ä¢ Other sectors: 40-45%\n\n\
                üìä Asset Class Diversification:\n\
                ‚Ä¢ Stocks: 60-80% (based on age/risk tolerance)\n\
                ‚Ä¢ Bonds: 15-35%\n\
                ‚Ä¢ REITs: 5-10%\n\
                ‚Ä¢ Commodities: 0-5%\n\n\
                üí° Remember: Don't over-diversify (20-30 stocks is often sufficient)"
            },
            "rebalancing" => {
                "‚öñÔ∏è Portfolio Rebalancing Guide:\n\n\
                Rebalancing maintains your target allocation and can improve returns:\n\n\
                üìÖ When to Rebalance:\n\
                ‚Ä¢ Quarterly or semi-annually\n\
                ‚Ä¢ When any asset class deviates >5% from target\n\
                ‚Ä¢ After major market movements\n\n\
                üîÑ How to Rebalance:\n\
                1. Calculate current allocations\n\
                2. Compare to target allocations\n\
                3. Sell overweight positions\n\
                4. Buy underweight positions\n\
                5. Consider tax implications\n\n\
                üí∞ Tax-Efficient Rebalancing:\n\
                ‚Ä¢ Use new contributions to buy underweight assets\n\
                ‚Ä¢ Rebalance in tax-advantaged accounts first\n\
                ‚Ä¢ Consider tax-loss harvesting opportunities"
            },
            "allocation" => {
                "üìä Asset Allocation Strategy:\n\n\
                Your asset allocation should match your risk tolerance and time horizon:\n\n\
                üë∂ Young Investors (20s-30s):\n\
                ‚Ä¢ Stocks: 80-90%\n\
                ‚Ä¢ Bonds: 10-20%\n\
                ‚Ä¢ High risk tolerance, long time horizon\n\n\
                üßë‚Äçüíº Middle-aged (40s-50s):\n\
                ‚Ä¢ Stocks: 60-70%\n\
                ‚Ä¢ Bonds: 30-40%\n\
                ‚Ä¢ Moderate risk, medium time horizon\n\n\
                üë¥ Pre-retirement (55+):\n\
                ‚Ä¢ Stocks: 40-60%\n\
                ‚Ä¢ Bonds: 40-60%\n\
                ‚Ä¢ Lower risk, shorter time horizon\n\n\
                üìà Rule of Thumb: Stock % = 100 - your age"
            },
            _ => {
                "üíº General Portfolio Management Tips:\n\n\
                Building a successful portfolio requires discipline and strategy:\n\n\
                üéØ Core Principles:\n\
                ‚Ä¢ Start with low-cost index funds\n\
                ‚Ä¢ Maintain proper diversification\n\
                ‚Ä¢ Invest regularly (dollar-cost averaging)\n\
                ‚Ä¢ Rebalance periodically\n\
                ‚Ä¢ Stay the course during volatility\n\n\
                üìä Portfolio Structure:\n\
                ‚Ä¢ Core holdings: 60-80% (broad market ETFs)\n\
                ‚Ä¢ Satellite holdings: 20-40% (sector/theme ETFs, individual stocks)\n\n\
                üö´ Common Mistakes to Avoid:\n\
                ‚Ä¢ Emotional investing\n\
                ‚Ä¢ Trying to time the market\n\
                ‚Ä¢ Over-concentration in one stock/sector\n\
                ‚Ä¢ Ignoring fees and taxes\n\
                ‚Ä¢ Lack of regular review"
            }
        };

        let recommendations = vec![
            "Review your portfolio monthly, rebalance quarterly".to_string(),
            "Keep investment costs low with index funds and ETFs".to_string(),
            "Stay disciplined and avoid emotional decision-making".to_string(),
            "Consider your tax situation when making changes".to_string(),
        ];

        let follow_up_questions = vec![
            "What's my ideal asset allocation based on my age?".to_string(),
            "How often should I rebalance my portfolio?".to_string(),
            "What are the best low-cost index funds?".to_string(),
            "Should I invest in individual stocks or ETFs?".to_string(),
        ];

        Ok(AIRecommendationResponse {
            response: response_text.to_string(),
            recommendations,
            relevant_stocks: vec!["SPY".to_string(), "VTI".to_string(), "QQQ".to_string()],
            confidence: 0.9,
            response_type: "advice".to_string(),
            follow_up_questions,
        })
    }

    async fn handle_market_prediction_query(&self, _request: &AIRecommendationRequest, intent: &QueryIntent) -> Result<AIRecommendationResponse> {
        let symbol = intent.entities.get("symbol").cloned().unwrap_or_else(|| "SPY".to_string());
        let timeframe = intent.entities.get("timeframe").cloned().unwrap_or_else(|| "30".to_string());

        // Get current market data
        let market_data = self.financial_service.get_market_data(MarketDataRequest {
            symbols: vec![symbol.clone()],
            timeframe: Some("1d".to_string()),
        }).await?;

        let current_data = market_data.data.first().unwrap();
        let current_price = current_data.price.to_f64().unwrap_or(0.0);

        // Generate prediction based on multiple factors
        let prediction = self.generate_price_prediction(&symbol, current_price, &timeframe);

        let response_text = format!(
            "üìà Price Prediction for {} ({}d horizon):\n\n\
            üîç Current Analysis:\n\
            ‚Ä¢ Current Price: ${:.2}\n\
            ‚Ä¢ Recent Change: {:+.2}%\n\
            ‚Ä¢ Volume: {:,}\n\n\
            üéØ Prediction:\n\
            ‚Ä¢ Predicted Price: ${:.2}\n\
            ‚Ä¢ Expected Change: {:+.2}%\n\
            ‚Ä¢ Confidence Range: ${:.2} - ${:.2}\n\n\
            üìä Key Factors:\n\
            {}\n\n\
            ‚ö†Ô∏è Important Disclaimer:\n\
            This prediction is based on technical indicators and historical patterns. \
            Market predictions are inherently uncertain and should not be the sole basis for investment decisions. \
            Past performance does not guarantee future results.",
            symbol,
            timeframe,
            current_price,
            current_data.change_percent.to_f64().unwrap_or(0.0),
            current_data.volume,
            prediction.predicted_price,
            prediction.expected_change,
            prediction.lower_bound,
            prediction.upper_bound,
            prediction.key_factors.join("\n‚Ä¢ ")
        );

        let recommendations = vec![
            "Use predictions as one factor among many in your decision-making".to_string(),
            "Consider setting stop-loss orders to manage risk".to_string(),
            "Monitor key support and resistance levels".to_string(),
            "Stay updated on company/sector news that could impact prices".to_string(),
        ];

        let follow_up_questions = vec![
            format!("What are the main risks for {} in the next month?", symbol),
            "How accurate are these predictions historically?".to_string(),
            format!("Should I buy {} at current levels?", symbol),
            "What technical indicators support this prediction?".to_string(),
        ];

        Ok(AIRecommendationResponse {
            response: response_text,
            recommendations,
            relevant_stocks: vec![symbol],
            confidence: prediction.confidence,
            response_type: "prediction".to_string(),
            follow_up_questions,
        })
    }

    async fn handle_investment_advice_query(&self, request: &AIRecommendationRequest, intent: &QueryIntent) -> Result<AIRecommendationResponse> {
        let symbol = intent.entities.get("symbol").cloned();
        let is_buy_query = intent.raw_query.contains("buy") || intent.raw_query.contains("invest");
        let is_sell_query = intent.raw_query.contains("sell");

        let response_text = if let Some(ref sym) = symbol {
            // Specific stock advice
            let analysis = self.financial_service.analyze_stock(StockAnalysisRequest {
                symbol: sym.clone(),
                analysis_type: "technical".to_string(),
                timeframe: Some("1mo".to_string()),
            }).await?;

            if is_buy_query {
                format!(
                    "ü§î Should you buy {}?\n\n\
                    Based on current analysis:\n\
                    ‚Ä¢ Technical Recommendation: {}\n\
                    ‚Ä¢ Confidence Level: {:.0}%\n\n\
                    üí° Investment Considerations:\n\
                    ‚Ä¢ Entry Point: Current price levels {} favorable\n\
                    ‚Ä¢ Risk Level: {} risk stock\n\
                    ‚Ä¢ Time Horizon: Best suited for {} investors\n\n\
                    üìã Before You Buy:\n\
                    1. Ensure it fits your portfolio allocation\n\
                    2. Consider your risk tolerance\n\
                    3. Don't invest more than 5-10% in a single stock\n\
                    4. Have a clear exit strategy\n\n\
                    üéØ Alternative Approach:\n\
                    Consider dollar-cost averaging over 2-3 months instead of a lump sum purchase.",
                    sym,
                    analysis.recommendation,
                    analysis.confidence * 100.0,
                    if analysis.recommendation == "BUY" { "appear" } else { "may not be" },
                    self.assess_stock_risk_level(sym),
                    if analysis.confidence > 0.7 { "medium to long-term" } else { "long-term" }
                )
            } else if is_sell_query {
                format!(
                    "ü§î Should you sell {}?\n\n\
                    Current Analysis suggests: {}\n\
                    Confidence: {:.0}%\n\n\
                    üîç Consider These Factors:\n\
                    ‚Ä¢ Has your investment thesis changed?\n\
                    ‚Ä¢ Do you need the money soon?\n\
                    ‚Ä¢ Are you rebalancing your portfolio?\n\
                    ‚Ä¢ Is this a tax-loss harvesting opportunity?\n\n\
                    üìä Selling Strategies:\n\
                    ‚Ä¢ Partial sale: Reduce position by 25-50%\n\
                    ‚Ä¢ Gradual exit: Sell over 2-3 months\n\
                    ‚Ä¢ Stop-loss: Set automatic sell order\n\n\
                    üí° Remember: Time in market > timing the market",
                    sym,
                    if analysis.recommendation == "SELL" { "Consider selling" } else { "Hold or accumulate" },
                    analysis.confidence * 100.0
                )
            } else {
                format!(
                    "üí° Investment Advice for {}:\n\n\
                    Current Recommendation: {}\n\
                    Analysis Summary: {}\n\n\
                    üéØ Strategic Approach:\n\
                    ‚Ä¢ Position Size: Limit to 5-10% of portfolio\n\
                    ‚Ä¢ Entry Strategy: Consider dollar-cost averaging\n\
                    ‚Ä¢ Exit Strategy: Set profit targets and stop-losses\n\
                    ‚Ä¢ Timeline: {} holding period recommended",
                    sym,
                    analysis.recommendation,
                    analysis.analysis_summary,
                    if analysis.confidence > 0.7 { "Medium to long-term" } else { "Long-term" }
                )
            }
        } else {
            // General investment advice
            "üí° General Investment Principles:\n\n\
            üéØ Core Investment Rules:\n\
            1. Start Early: Time is your greatest asset\n\
            2. Diversify: Don't put all eggs in one basket\n\
            3. Stay Consistent: Regular investing beats timing\n\
            4. Keep Costs Low: Fees compound negatively\n\
            5. Stay Patient: Wealth building takes time\n\n\
            üìä Building Your Portfolio:\n\
            ‚Ä¢ Emergency Fund: 3-6 months expenses first\n\
            ‚Ä¢ Core Holdings: 60-80% in broad market ETFs\n\
            ‚Ä¢ Satellite Holdings: 20-40% in specific sectors/stocks\n\
            ‚Ä¢ Risk Management: Never invest money you can't afford to lose\n\n\
            üöÄ Getting Started:\n\
            ‚Ä¢ Open a brokerage account\n\
            ‚Ä¢ Start with index funds (VTI, VOO, QQQ)\n\
            ‚Ä¢ Automate your investments\n\
            ‚Ä¢ Increase contributions annually\n\n\
            üíº Advanced Strategies (once you have the basics):\n\
            ‚Ä¢ Individual stock selection\n\
            ‚Ä¢ Sector rotation\n\
            ‚Ä¢ Options strategies\n\
            ‚Ä¢ Alternative investments".to_string()
        };

        let recommendations = vec![
            "Never invest money you can't afford to lose".to_string(),
            "Diversification is your best defense against risk".to_string(),
            "Regular investing beats trying to time the market".to_string(),
            "Always do your own research before investing".to_string(),
        ];

        let relevant_stocks = if symbol.is_some() {
            vec![symbol.unwrap()]
        } else {
            vec!["VTI".to_string(), "VOO".to_string(), "QQQ".to_string()]
        };

        let follow_up_questions = vec![
            "What's the best portfolio allocation for my age?".to_string(),
            "How much should I invest each month?".to_string(),
            "What are the best index funds for beginners?".to_string(),
            "How do I evaluate individual stocks?".to_string(),
        ];

        Ok(AIRecommendationResponse {
            response: response_text,
            recommendations,
            relevant_stocks,
            confidence: 0.85,
            response_type: "advice".to_string(),
            follow_up_questions,
        })
    }

    async fn handle_risk_assessment_query(&self, _request: &AIRecommendationRequest, intent: &QueryIntent) -> Result<AIRecommendationResponse> {
        let symbol = intent.entities.get("symbol").cloned();

        let response_text = if let Some(ref sym) = symbol {
            // Specific stock risk assessment
            format!(
                "‚ö†Ô∏è Risk Assessment for {}:\n\n\
                üéØ Risk Level: {} Risk\n\
                üìä Key Risk Factors:\n\
                {}\n\n\
                üìà Historical Volatility: {}% (annualized)\n\
                üìâ Maximum Drawdown: {}% (last 2 years)\n\
                üîÑ Beta: {} (vs S&P 500)\n\n\
                üí° Risk Management Tips:\n\
                ‚Ä¢ Position Size: Limit to 5-10% of portfolio\n\
                ‚Ä¢ Stop Loss: Consider setting at -15% to -20%\n\
                ‚Ä¢ Diversification: Don't concentrate in similar stocks\n\
                ‚Ä¢ Time Horizon: Longer periods reduce risk\n\n\
                ‚öñÔ∏è Risk vs Reward:\n\
                Higher risk stocks like {} can offer greater returns but also greater losses. \
                Make sure this aligns with your risk tolerance and investment goals.",
                sym,
                self.assess_stock_risk_level(sym),
                self.get_stock_risk_factors(sym).join("\n‚Ä¢ "),
                self.get_mock_volatility(sym),
                self.get_mock_max_drawdown(sym),
                self.get_mock_beta(sym),
                sym
            )
        } else {
            // General risk assessment
            "‚ö†Ô∏è Investment Risk Assessment Guide:\n\n\
            üéØ Types of Investment Risk:\n\
            ‚Ä¢ Market Risk: Overall market declines\n\
            ‚Ä¢ Company Risk: Specific business issues\n\
            ‚Ä¢ Sector Risk: Industry-wide problems\n\
            ‚Ä¢ Liquidity Risk: Difficulty selling quickly\n\
            ‚Ä¢ Inflation Risk: Purchasing power erosion\n\
            ‚Ä¢ Interest Rate Risk: Rate changes affect valuations\n\n\
            üìä Risk Tolerance Levels:\n\
            üü¢ Conservative: 0-30% stocks, focus on preservation\n\
            üü° Moderate: 40-70% stocks, balanced approach\n\
            üî¥ Aggressive: 80-100% stocks, growth focused\n\n\
            üõ°Ô∏è Risk Management Strategies:\n\
            1. Diversification: Spread investments across assets\n\
            2. Asset Allocation: Match risk to time horizon\n\
            3. Regular Rebalancing: Maintain target allocations\n\
            4. Emergency Fund: Keep 3-6 months expenses liquid\n\
            5. Dollar-Cost Averaging: Reduce timing risk\n\n\
            üí° Remember: Higher potential returns come with higher risk. \
            Never invest more than you can afford to lose.".to_string()
        };

        let recommendations = vec![
            "Assess your risk tolerance honestly before investing".to_string(),
            "Diversify across different asset classes and sectors".to_string(),
            "Never put more than 10% in any single stock".to_string(),
            "Review and adjust your risk profile annually".to_string(),
        ];

        let relevant_stocks = if symbol.is_some() {
            vec![symbol.unwrap()]
        } else {
            vec!["SPY".to_string(), "BND".to_string(), "VTI".to_string()]
        };

        Ok(AIRecommendationResponse {
            response: response_text,
            recommendations,
            relevant_stocks,
            confidence: 0.9,
            response_type: "advice".to_string(),
            follow_up_questions: vec![
                "What's my ideal risk level based on my age?".to_string(),
                "How do I calculate portfolio risk?".to_string(),
                "What are safe investments for beginners?".to_string(),
                "Should I reduce risk as I get older?".to_string(),
            ],
        })
    }

    async fn handle_market_news_query(&self, _request: &AIRecommendationRequest, _intent: &QueryIntent) -> Result<AIRecommendationResponse> {
        // Generate mock market news summary
        let response_text = "üì∞ Today's Market Headlines:\n\n\
            üî¥ Major Indices:\n\
            ‚Ä¢ S&P 500: Mixed performance amid earnings season\n\
            ‚Ä¢ NASDAQ: Tech stocks showing resilience\n\
            ‚Ä¢ Dow Jones: Industrial stocks under pressure\n\n\
            üìä Sector Performance:\n\
            ‚Ä¢ Technology: Leading gains (+1.2%)\n\
            ‚Ä¢ Healthcare: Defensive strength (+0.8%)\n\
            ‚Ä¢ Energy: Volatile on oil price swings (-0.5%)\n\
            ‚Ä¢ Financial: Rate sensitivity continues (-0.3%)\n\n\
            üè¶ Fed Policy:\n\
            ‚Ä¢ Interest rate decisions being closely watched\n\
            ‚Ä¢ Inflation data showing mixed signals\n\
            ‚Ä¢ Market pricing in policy changes\n\n\
            üåç Global Markets:\n\
            ‚Ä¢ European markets showing strength\n\
            ‚Ä¢ Asian markets mixed on trade concerns\n\
            ‚Ä¢ Emerging markets facing currency pressures\n\n\
            üí° What This Means for Investors:\n\
            Current market conditions suggest continued volatility. \
            Focus on quality companies with strong fundamentals. \
            Consider defensive positioning while maintaining long-term perspective.".to_string();

        Ok(AIRecommendationResponse {
            response: response_text,
            recommendations: vec![
                "Stay informed but don't make hasty decisions based on daily news".to_string(),
                "Focus on long-term trends rather than short-term volatility".to_string(),
                "Use market dips as potential buying opportunities".to_string(),
            ],
            relevant_stocks: vec!["SPY".to_string(), "QQQ".to_string(), "DIA".to_string()],
            confidence: 0.8,
            response_type: "news".to_string(),
            follow_up_questions: vec![
                "How do I filter important news from noise?".to_string(),
                "Should I adjust my portfolio based on current events?".to_string(),
                "What are the best financial news sources?".to_string(),
            ],
        })
    }

    async fn handle_educational_query(&self, _request: &AIRecommendationRequest, intent: &QueryIntent) -> Result<AIRecommendationResponse> {
        let topic = self.identify_educational_topic(&intent.raw_query);
        
        let response_text = match topic {
            "dividend" => self.knowledge_base.get_dividend_explanation(),
            "pe_ratio" => self.knowledge_base.get_pe_ratio_explanation(),
            "market_cap" => self.knowledge_base.get_market_cap_explanation(),
            "etf" => self.knowledge_base.get_etf_explanation(),
            "volatility" => self.knowledge_base.get_volatility_explanation(),
            "beta" => self.knowledge_base.get_beta_explanation(),
            "earnings" => self.knowledge_base.get_earnings_explanation(),
            _ => self.knowledge_base.get_general_explanation(),
        };

        Ok(AIRecommendationResponse {
            response: response_text,
            recommendations: vec![
                "Continue learning - financial education is an ongoing process".to_string(),
                "Practice with small amounts before making large investments".to_string(),
                "Consider taking a finance course or reading investment books".to_string(),
            ],
            relevant_stocks: vec![],
            confidence: 0.95,
            response_type: "explanation".to_string(),
            follow_up_questions: vec![
                "Can you explain this with a real example?".to_string(),
                "What are the practical applications?".to_string(),
                "How does this affect my investment decisions?".to_string(),
            ],
        })
    }

    async fn handle_general_query(&self, _request: &AIRecommendationRequest, _intent: &QueryIntent) -> Result<AIRecommendationResponse> {
        let response_text = "ü§ñ I'm your Financial AI Assistant!\n\n\
            I can help you with:\n\n\
            üìä Stock Analysis:\n\
            ‚Ä¢ \"Analyze Apple stock\"\n\
            ‚Ä¢ \"How is Tesla performing?\"\n\
            ‚Ä¢ \"Should I buy Microsoft?\"\n\n\
            üíº Portfolio Management:\n\
            ‚Ä¢ \"Review my portfolio\"\n\
            ‚Ä¢ \"How should I diversify?\"\n\
            ‚Ä¢ \"What's my risk level?\"\n\n\
            üìà Market Insights:\n\
            ‚Ä¢ \"Market news today\"\n\
            ‚Ä¢ \"Predict Amazon price\"\n\
            ‚Ä¢ \"Best tech stocks\"\n\n\
            üéì Financial Education:\n\
            ‚Ä¢ \"What is a P/E ratio?\"\n\
            ‚Ä¢ \"Explain dividends\"\n\
            ‚Ä¢ \"How do ETFs work?\"\n\n\
            üí° Just ask me anything about investing, stocks, or financial markets in natural language!".to_string();

        Ok(AIRecommendationResponse {
            response: response_text,
            recommendations: vec![
                "Ask specific questions about stocks you're interested in".to_string(),
                "I can analyze your portfolio if you share your holdings".to_string(),
                "Feel free to ask for explanations of financial concepts".to_string(),
            ],
            relevant_stocks: vec![],
            confidence: 1.0,
            response_type: "help".to_string(),
            follow_up_questions: vec![
                "Analyze Apple stock for me".to_string(),
                "What's the best investment strategy for beginners?".to_string(),
                "How do I build a diversified portfolio?".to_string(),
                "What are the top stocks to buy now?".to_string(),
            ],
        })
    }

    // Helper methods
    fn determine_overall_sentiment(&self, technical: &StockAnalysisResponse, fundamental: &StockAnalysisResponse) -> &str {
        match (technical.recommendation.as_str(), fundamental.recommendation.as_str()) {
            ("BUY", "BUY") => "strongly positioned",
            ("BUY", _) | (_, "BUY") => "well positioned",
            ("SELL", "SELL") => "facing challenges",
            ("SELL", _) | (_, "SELL") => "showing mixed signals",
            _ => "in a neutral position",
        }
    }

    fn describe_momentum(&self, analysis: &StockAnalysisResponse) -> &str {
        match analysis.recommendation.as_str() {
            "BUY" => "bullish",
            "SELL" => "bearish",
            _ => "neutral",
        }
    }

    fn describe_value(&self, analysis: &StockAnalysisResponse) -> &str {
        if analysis.confidence > 0.7 {
            match analysis.recommendation.as_str() {
                "BUY" => "attractive",
                "SELL" => "concerning",
                _ => "fair",
            }
        } else {
            "uncertain"
        }
    }

    fn generate_price_prediction(&self, _symbol: &str, current_price: f64, timeframe: &str) -> PricePredictionData {
        use rand::Rng;
        let mut rng = rand::thread_rng();
        
        let days: f64 = timeframe.parse().unwrap_or(30.0);
        let volatility = 0.02; // 2% daily volatility
        
        // Generate a random walk with slight upward bias
        let expected_return = 0.001 * days; // 0.1% daily expected return
        let predicted_change = rng.gen_range(-0.1..0.15) + expected_return;
        
        let predicted_price = current_price * (1.0 + predicted_change);
        let confidence_range = current_price * volatility * (days / 30.0).sqrt();
        
        PricePredictionData {
            predicted_price,
            expected_change: predicted_change * 100.0,
            lower_bound: predicted_price - confidence_range,
            upper_bound: predicted_price + confidence_range,
            confidence: 0.65,
            key_factors: vec![
                "Technical indicators showing mixed signals".to_string(),
                "Market volatility remains elevated".to_string(),
                "Sector trends are generally positive".to_string(),
                "Economic indicators are stable".to_string(),
            ],
        }
    }

    fn assess_stock_risk_level(&self, symbol: &str) -> &str {
        match symbol {
            "AAPL" | "MSFT" | "GOOGL" | "JNJ" | "PG" => "Moderate",
            "TSLA" | "NVDA" | "AMD" | "PLTR" => "High",
            "KO" | "WMT" | "VZ" | "T" => "Low",
            _ => "Moderate",
        }
    }

    fn get_stock_risk_factors(&self, symbol: &str) -> Vec<String> {
        match symbol {
            "TSLA" => vec![
                "High volatility and price swings".to_string(),
                "Regulatory changes in EV industry".to_string(),
                "Competition from traditional automakers".to_string(),
                "Dependence on CEO leadership".to_string(),
            ],
            "AAPL" => vec![
                "iPhone sales dependency".to_string(),
                "China market exposure".to_string(),
                "Tech regulation risks".to_string(),
                "Supply chain disruptions".to_string(),
            ],
            _ => vec![
                "Market volatility".to_string(),
                "Economic recession risk".to_string(),
                "Interest rate changes".to_string(),
                "Industry competition".to_string(),
            ],
        }
    }

    fn get_mock_volatility(&self, symbol: &str) -> f64 {
        match symbol {
            "TSLA" => 65.0,
            "NVDA" => 55.0,
            "AAPL" => 25.0,
            "MSFT" => 22.0,
            "SPY" => 18.0,
            _ => 30.0,
        }
    }

    fn get_mock_max_drawdown(&self, symbol: &str) -> f64 {
        match symbol {
            "TSLA" => 45.0,
            "NVDA" => 35.0,
            "AAPL" => 20.0,
            "MSFT" => 18.0,
            "SPY" => 15.0,
            _ => 25.0,
        }
    }

    fn get_mock_beta(&self, symbol: &str) -> f64 {
        match symbol {
            "TSLA" => 2.1,
            "NVDA" => 1.8,
            "AAPL" => 1.2,
            "MSFT" => 0.9,
            "SPY" => 1.0,
            _ => 1.1,
        }
    }

    fn identify_educational_topic(&self, query: &str) -> &str {
        let query_lower = query.to_lowercase();
        
        if query_lower.contains("dividend") {
            "dividend"
        } else if query_lower.contains("p/e") || query_lower.contains("pe ratio") {
            "pe_ratio"
        } else if query_lower.contains("market cap") {
            "market_cap"
        } else if query_lower.contains("etf") {
            "etf"
        } else if query_lower.contains("volatility") {
            "volatility"
        } else if query_lower.contains("beta") {
            "beta"
        } else if query_lower.contains("earnings") {
            "earnings"
        } else {
            "general"
        }
    }
}

#[derive(Debug)]
struct QueryIntent {
    intent_type: String,
    confidence: f64,
    entities: HashMap<String, String>,
    raw_query: String,
}

#[derive(Debug)]
struct PricePredictionData {
    predicted_price: f64,
    expected_change: f64,
    lower_bound: f64,
    upper_bound: f64,
    confidence: f64,
    key_factors: Vec<String>,
}

// Financial Knowledge Base for educational queries
struct FinancialKnowledgeBase;

impl FinancialKnowledgeBase {
    fn new() -> Self {
        Self
    }

    fn get_dividend_explanation(&self) -> String {
        "üí∞ Dividends Explained:\n\n\
        A dividend is a payment made by corporations to their shareholders, typically as a distribution of profits.\n\n\
        üîç Key Points:\n\
        ‚Ä¢ Quarterly payments: Most US companies pay every 3 months\n\
        ‚Ä¢ Dividend yield: Annual dividend √∑ stock price\n\
        ‚Ä¢ Ex-dividend date: Last day to buy and still receive dividend\n\
        ‚Ä¢ Payout ratio: Percentage of earnings paid as dividends\n\n\
        üìä Example:\n\
        If Apple pays $0.92/quarter and trades at $180:\n\
        ‚Ä¢ Annual dividend: $0.92 √ó 4 = $3.68\n\
        ‚Ä¢ Dividend yield: $3.68 √∑ $180 = 2.04%\n\n\
        üí° Investment Strategy:\n\
        ‚Ä¢ Dividend stocks provide regular income\n\
        ‚Ä¢ Look for sustainable payout ratios (<60%)\n\
        ‚Ä¢ Consider dividend growth, not just yield\n\
        ‚Ä¢ Dividend aristocrats: 25+ years of increases".to_string()
    }

    fn get_pe_ratio_explanation(&self) -> String {
        "üìä P/E Ratio (Price-to-Earnings) Explained:\n\n\
        P/E ratio measures how much investors are willing to pay for each dollar of earnings.\n\n\
        üßÆ Calculation:\n\
        P/E Ratio = Stock Price √∑ Earnings Per Share (EPS)\n\n\
        üìà Interpretation:\n\
        ‚Ä¢ Low P/E (5-15): Potentially undervalued or slow growth\n\
        ‚Ä¢ Medium P/E (15-25): Fairly valued\n\
        ‚Ä¢ High P/E (25+): Growth expectations or overvalued\n\n\
        üìä Example:\n\
        Stock Price: $100, EPS: $5\n\
        P/E Ratio = $100 √∑ $5 = 20\n\
        This means investors pay $20 for every $1 of earnings\n\n\
        ‚ö†Ô∏è Limitations:\n\
        ‚Ä¢ Compare within same industry\n\
        ‚Ä¢ Consider growth prospects\n\
        ‚Ä¢ One-time events can distort EPS\n\
        ‚Ä¢ Use forward P/E for future estimates".to_string()
    }

    fn get_market_cap_explanation(&self) -> String {
        "üè¢ Market Capitalization Explained:\n\n\
        Market cap is the total value of all company shares in the market.\n\n\
        üßÆ Calculation:\n\
        Market Cap = Share Price √ó Total Shares Outstanding\n\n\
        üìä Categories:\n\
        ‚Ä¢ Large-cap: $10B+ (Apple, Microsoft)\n\
        ‚Ä¢ Mid-cap: $2B-$10B (growing companies)\n\
        ‚Ä¢ Small-cap: $300M-$2B (higher growth potential)\n\
        ‚Ä¢ Micro-cap: <$300M (highest risk/reward)\n\n\
        üìà Example:\n\
        Company A: $50/share √ó 100M shares = $5B market cap\n\
        Company B: $25/share √ó 80M shares = $2B market cap\n\
        Company A is larger despite lower share count\n\n\
        üí° Investment Implications:\n\
        ‚Ä¢ Large-cap: More stable, lower growth\n\
        ‚Ä¢ Small-cap: More volatile, higher growth potential\n\
        ‚Ä¢ Diversify across market caps\n\
        ‚Ä¢ Market cap affects index inclusion".to_string()
    }

    fn get_etf_explanation(&self) -> String {
        "üì¶ ETFs (Exchange-Traded Funds) Explained:\n\n\
        ETFs are investment funds that trade on stock exchanges like individual stocks.\n\n\
        üîç How They Work:\n\
        ‚Ä¢ Pool money from many investors\n\
        ‚Ä¢ Buy a basket of securities (stocks, bonds)\n\
        ‚Ä¢ Shares trade throughout market hours\n\
        ‚Ä¢ Typically track an index\n\n\
        üí™ Advantages:\n\
        ‚Ä¢ Instant diversification\n\
        ‚Ä¢ Low expense ratios (0.03%-0.75%)\n\
        ‚Ä¢ Liquid - easy to buy/sell\n\
        ‚Ä¢ Tax efficient\n\
        ‚Ä¢ Transparent holdings\n\n\
        üìä Popular ETFs:\n\
        ‚Ä¢ SPY: S&P 500 index\n\
        ‚Ä¢ QQQ: NASDAQ-100\n\
        ‚Ä¢ VTI: Total stock market\n\
        ‚Ä¢ BND: Bond market\n\n\
        üéØ Types:\n\
        ‚Ä¢ Broad market (VTI, VOO)\n\
        ‚Ä¢ Sector specific (XLK tech, XLF financial)\n\
        ‚Ä¢ International (VEA, VWO)\n\
        ‚Ä¢ Bond (AGG, TLT)\n\
        ‚Ä¢ Thematic (clean energy, AI)".to_string()
    }

    fn get_volatility_explanation(&self) -> String {
        "üìàüìâ Volatility Explained:\n\n\
        Volatility measures how much a stock's price fluctuates over time.\n\n\
        üîç Key Concepts:\n\
        ‚Ä¢ High volatility: Large price swings\n\
        ‚Ä¢ Low volatility: Stable price movements\n\
        ‚Ä¢ Measured as standard deviation of returns\n\
        ‚Ä¢ Usually annualized (% per year)\n\n\
        üìä Volatility Levels:\n\
        ‚Ä¢ Low: <15% (utilities, consumer staples)\n\
        ‚Ä¢ Medium: 15-25% (large-cap stocks)\n\
        ‚Ä¢ High: 25-40% (growth stocks, small-caps)\n\
        ‚Ä¢ Very High: >40% (crypto, penny stocks)\n\n\
        üí° Investment Implications:\n\
        ‚Ä¢ Higher volatility = higher potential returns\n\
        ‚Ä¢ Also means higher potential losses\n\
        ‚Ä¢ Young investors can handle more volatility\n\
        ‚Ä¢ Near retirement: focus on low volatility\n\n\
        üõ°Ô∏è Managing Volatility:\n\
        ‚Ä¢ Diversification reduces portfolio volatility\n\
        ‚Ä¢ Dollar-cost averaging smooths entry points\n\
        ‚Ä¢ Long-term holding reduces impact".to_string()
    }

    fn get_beta_explanation(&self) -> String {
        "üìä Beta Explained:\n\n\
        Beta measures how much a stock moves relative to the overall market.\n\n\
        üßÆ Understanding Beta:\n\
        ‚Ä¢ Beta = 1.0: Moves with market\n\
        ‚Ä¢ Beta > 1.0: More volatile than market\n\
        ‚Ä¢ Beta < 1.0: Less volatile than market\n\
        ‚Ä¢ Beta = 0: No correlation with market\n\
        ‚Ä¢ Negative beta: Moves opposite to market\n\n\
        üìà Examples:\n\
        ‚Ä¢ Tech stocks: Often beta > 1.5\n\
        ‚Ä¢ Utilities: Often beta < 0.8\n\
        ‚Ä¢ Gold stocks: Sometimes negative beta\n\n\
        üíº Portfolio Applications:\n\
        ‚Ä¢ High-beta stocks for growth\n\
        ‚Ä¢ Low-beta stocks for stability\n\
        ‚Ä¢ Portfolio beta = weighted average\n\
        ‚Ä¢ Defensive positioning with low beta\n\n\
        ‚ö†Ô∏è Limitations:\n\
        ‚Ä¢ Based on historical data\n\
        ‚Ä¢ Can change over time\n\
        ‚Ä¢ Market conditions affect reliability\n\
        ‚Ä¢ Consider alongside other metrics".to_string()
    }

    fn get_earnings_explanation(&self) -> String {
        "üíº Earnings Explained:\n\n\
        Earnings represent a company's profit after all expenses, taxes, and costs.\n\n\
        üìä Key Metrics:\n\
        ‚Ä¢ EPS: Earnings Per Share\n\
        ‚Ä¢ Revenue: Total sales/income\n\
        ‚Ä¢ Net income: Bottom line profit\n\
        ‚Ä¢ Operating income: Before interest/taxes\n\n\
        üìÖ Earnings Season:\n\
        ‚Ä¢ Quarterly reports (Q1, Q2, Q3, Q4)\n\
        ‚Ä¢ January, April, July, October\n\
        ‚Ä¢ Companies report results vs estimates\n\
        ‚Ä¢ Guidance for future quarters\n\n\
        üìà What to Watch:\n\
        ‚Ä¢ Beat or miss expectations\n\
        ‚Ä¢ Revenue growth trends\n\
        ‚Ä¢ Profit margin changes\n\
        ‚Ä¢ Forward guidance updates\n\
        ‚Ä¢ Management commentary\n\n\
        üí° Investment Impact:\n\
        ‚Ä¢ Strong earnings often boost stock price\n\
        ‚Ä¢ Misses can cause significant drops\n\
        ‚Ä¢ Guidance matters more than past results\n\
        ‚Ä¢ Look for sustainable growth trends\n\
        ‚Ä¢ Quality of earnings (one-time vs recurring)".to_string()
    }

    fn get_general_explanation(&self) -> String {
        "üìö Financial Education Hub:\n\n\
        I can explain various financial concepts:\n\n\
        üìä Valuation Metrics:\n\
        ‚Ä¢ P/E Ratio, P/B Ratio, PEG Ratio\n\
        ‚Ä¢ Market Cap, Enterprise Value\n\
        ‚Ä¢ Dividend Yield, Payout Ratio\n\n\
        üìà Investment Vehicles:\n\
        ‚Ä¢ Stocks, Bonds, ETFs, Mutual Funds\n\
        ‚Ä¢ Options, REITs, Commodities\n\
        ‚Ä¢ Index Funds vs Active Funds\n\n\
        üìâ Risk Concepts:\n\
        ‚Ä¢ Volatility, Beta, Correlation\n\
        ‚Ä¢ Diversification, Asset Allocation\n\
        ‚Ä¢ Risk vs Return Trade-off\n\n\
        üíº Financial Statements:\n\
        ‚Ä¢ Income Statement, Balance Sheet\n\
        ‚Ä¢ Cash Flow Statement\n\
        ‚Ä¢ Key Financial Ratios\n\n\
        Just ask me about any financial term or concept you'd like to understand better!".to_string()
    }
}